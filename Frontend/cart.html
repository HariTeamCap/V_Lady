<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>V Lady | Cart</title>
  <link rel="stylesheet" href="cart.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
</head>
<body>

<header>
  <div class="logo">
    V LADY
    <div class="tagline">Versatile Lady</div>
  </div>
  <nav>
    <ul class="nav-links">
      <li><a href="mainpage.html"><i class="fa fa-house-chimney"></i></a></li>
      <li><a href="about.html"><i class="fa fa-circle-info"></i></a></li>
      <li><a href="cart.html"><i class="fa-solid fa-cart-shopping"></i></a></li>
      <li><a href="mainpage.html"><i class="fa fa-envelope"></i></a></li>
    </ul>
  </nav>
</header>

<div id="bannerText">THE LADY WHO LEADS</div>

<section class="cart-section">
  <h2>üõí YOUR SHOPPING CART</h2>
  <div class="cart-items">
    <!-- Cart items will be dynamically injected here -->
  </div>

  <div class="cart-summary">
    <p>Total: <span id="cart-total">‚Çπ0</span></p>

    <!-- Address Section -->
    <div class="address-section">
      <h3>Shipping Address</h3>
      <input type="text" id="name" placeholder="Full Name" required />
      <input type="text" id="phone" placeholder="Phone Number" required />
      <input type="text" id="house" placeholder="House/Flat Number" required />
      <input type="text" id="locality" placeholder="Locality" required />
      <input type="text" id="city" placeholder="City" required />
      <input type="text" id="pincode" placeholder="Pincode" required />
      <input type="text" id="area" placeholder="Area (Optional)" />
      <input type="text" id="landmark" placeholder="Landmark (Optional)" />

    </div>

    <!-- Coupon Section -->
    <div class="coupon-section">
      <input type="text" id="coupon-code" placeholder="Enter coupon code" />
      <button id="apply-coupon">Apply Now</button>
    </div>

    <!-- Pay and Shop Buttons -->
    <button class="pay-btn">Pay Now</button>
    <button class="btn shop-more" onclick="window.location.href='mainpage.html'">Shop More</button>
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB_8hb_E4zqF9sbv8sSx31ZcLXGC5SvSAM",
    authDomain: "studio-1046644394-281ce.firebaseapp.com",
    projectId: "studio-1046644394-281ce",
    storageBucket: "studio-1046644394-281ce.firebasestorage.app",
    messagingSenderId: "722558821135",
    appId: "1:722558821135:web:e67939ec381bf1922b547a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  document.addEventListener("DOMContentLoaded", () => {
    const cartContainer = document.querySelector(".cart-section");
    const cartItemsDiv = cartContainer.querySelector(".cart-items");
    const totalSpan = document.getElementById("cart-total");
    const payBtn = document.querySelector(".pay-btn");
    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    let discountApplied = false;

    // Render cart items
    function renderCart() {
      cartItemsDiv.innerHTML = "";
      if (cart.length === 0) {
        cartContainer.innerHTML = "<p>Your cart is empty üõí</p>";
        return;
      }

      cart.forEach(product => {
        const itemDiv = document.createElement("div");
        itemDiv.classList.add("cart-item");
        itemDiv.dataset.productId = product.id;

        itemDiv.innerHTML = `
          <img src="${product.image}" alt="${product.name}" />
          <div class="item-details">
            <h3>${product.name}</h3>
            <p class="price">‚Çπ${product.price}/-</p>
          </div>
          <div class="item-controls">
            <button class="qty-btn minus">‚àí</button>
            <span class="quantity">${product.quantity || 1}</span>
            <button class="qty-btn plus">+</button>
            <button class="delete-btn">üóë</button>
          </div>
        `;

        const qtySpan = itemDiv.querySelector(".quantity");

        // Minus button
        itemDiv.querySelector(".minus").addEventListener("click", () => {
          if (product.quantity > 1) {
            product.quantity--;
            qtySpan.textContent = product.quantity;
            localStorage.setItem("cart", JSON.stringify(cart));
            updateTotal();
          }
        });

        // Plus button
        itemDiv.querySelector(".plus").addEventListener("click", () => {
          product.quantity++;
          qtySpan.textContent = product.quantity;
          localStorage.setItem("cart", JSON.stringify(cart));
          updateTotal();
        });

        // Delete button
        itemDiv.querySelector(".delete-btn").addEventListener("click", () => {
          cart = cart.filter(p => p.id !== product.id);
          localStorage.setItem("cart", JSON.stringify(cart));
          renderCart();
        });

        cartItemsDiv.appendChild(itemDiv);
      });

      updateTotal();
    }

    // Total calculation (‚úÖ Fixed)
    function updateTotal() {
      let total = 0;
      cart.forEach(product => {
        const priceNum = parseFloat(
          typeof product.price === "string"
            ? product.price.replace(/[^\d.]/g, "")
            : product.price
        );
        const qty = product.quantity || 1;
        total += priceNum * qty;
      });

      if (discountApplied) total = Math.round(total / 2);
      totalSpan.textContent = `‚Çπ${total}`;
    }

    // ===== Coupon Code =====
    const couponInput = document.getElementById("coupon-code");
    const applyBtn = document.getElementById("apply-coupon");

    applyBtn.addEventListener("click", () => {
      const code = couponInput.value;
      if (code === "WELCOME50") {
        if (!discountApplied) {
          discountApplied = true;
          updateTotal();
          alert("üéâ Congratulations! You have applied 50% discount successfully!");
        } else {
          alert("Coupon already applied!");
        }
      } else {
        alert("‚ùå Incorrect code applied. Please Try Again.");
      }
    });

    // ===== Pay Now Button =====
    payBtn.addEventListener("click", async () => {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const house = document.getElementById("house").value.trim();
      const locality = document.getElementById("locality").value.trim();
      const city = document.getElementById("city").value.trim();
      const pincode = document.getElementById("pincode").value.trim();

      if (!name || !phone || !house || !locality || !city || !pincode) {
        alert("‚ùå Please fill in all required address details before proceeding!");
        return;
      }

      if (cart.length === 0) {
        alert("Cart is empty!");
        return;
      }

      const totalAmount = parseFloat(totalSpan.textContent.replace(/[^\d.]/g, ""));

      const customerInfo = {
        name,
        phone,
        address: `${house}, ${locality}, ${city} - ${pincode}`,
        total: totalAmount,
        paymentMethod: "Cash on Delivery",
      };

      try {
        await addDoc(collection(db, "orders"), {
          customerName: customerInfo.name,
          customerPhone: customerInfo.phone,
          address: customerInfo.address,
          totalAmount: customerInfo.total,
          paymentMethod: customerInfo.paymentMethod,
          items: cart,
          status: "Pending",
          createdAt: serverTimestamp(),
        });

        alert("‚úÖ Order placed successfully!");
        localStorage.removeItem("cart");
        window.location.href = "mainpage.html";
      } catch (e) {
        console.error("Error placing order: ", e);
        alert("‚ùå Error placing order. Please try again!");
      }
    });

    renderCart();
  });
</script>
<script>
window.addEventListener("scroll", function() {
  const text = document.getElementById("bannerText");
  if (window.scrollY > 100) {
    text.classList.add("hide");
  } else {
    text.classList.remove("hide");
  }
});
</script>


</body>
</html>