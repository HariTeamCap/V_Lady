<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>V Lady | Cart</title>
  <link rel="stylesheet" href="cart.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
</head>
<body>

<header>
  <div class="logo">
    V LADY
    <div class="tagline">Versatile Lady</div>
  </div>
  <nav>
    <ul class="nav-links">
      <li><a href="mainpage.html"><i class="fa fa-house-chimney"></i></a></li>
      <li><a href="about.html"><i class="fa fa-circle-info"></i></a></li>
      <li><a href="cart.html"><i class="fa-solid fa-cart-shopping"></i></a></li>
      <li><a href="mainpage.html"><i class="fa fa-envelope"></i></a></li>
    </ul>
  </nav>
</header>

<!-- Pink Banner -->
<div class="pink-banner">
  <div class="scrolling-text">
    THE LADY WHO LEADS
  </div>
</div>

<section class="cart-section">
  <h2>üõí YOUR SHOPPING CART</h2>
  <div class="cart-items">
    <!-- Cart items will be dynamically injected here -->
  </div>

  <div class="cart-summary">
    <p>Total: <span id="cart-total">‚Çπ0</span></p>

    <!-- Address Section -->
    <div class="address-section">
      <h3>Shipping Address</h3>
      <input type="text" id="name" placeholder="Full Name" required />
      <input type="text" id="phone" placeholder="Phone Number" required />
      <input type="text" id="house" placeholder="House/Flat Number" required />
      <input type="text" id="locality" placeholder="Locality" required />
      <input type="text" id="city" placeholder="City" required />
      <input type="text" id="pincode" placeholder="Pincode" required />
      <input type="text" id="area" placeholder="Area (Optional)" />
      <input type="text" id="landmark" placeholder="Landmark (Optional)" />
    </div>

    <!-- Coupon Section -->
    <div class="coupon-section">
      <input type="text" id="coupon-code" placeholder="Enter coupon code" />
      <button id="apply-coupon">Apply Now</button>
    </div>

    <!-- Pay and Shop Buttons -->
    <button class="pay-btn">Pay Now</button>
    <button class="btn shop-more" onclick="window.location.href='mainpage.html'">Shop More</button>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const cartContainer = document.querySelector(".cart-section");
  const cartItemsDiv = cartContainer.querySelector(".cart-items");
  const totalSpan = document.getElementById("cart-total");
  const payBtn = document.querySelector(".pay-btn");

  let user = null;

  try {
    const response = await fetch('/api/user');
    if (response.ok) {
      user = await response.json();
    } else {
      window.location.href = 'login.html';
      return;
    }
  } catch (error) {
    console.error('Error fetching user status:', error);
    window.location.href = 'login.html';
    return;
  }

  async function renderCart() {
    try {
      const response = await fetch('/api/cart');
      const cart = await response.json();

      cartItemsDiv.innerHTML = "";
      if (!cart || cart.items.length === 0) {
        cartContainer.innerHTML = "<p>Your cart is empty üõí</p>";
        return;
      }

      cart.items.forEach(item => {
        const itemDiv = document.createElement("div");
        itemDiv.classList.add("cart-item");
        itemDiv.dataset.productId = item.productId._id;

        itemDiv.innerHTML = `
          <img src="${item.productId.image}" alt="${item.productId.name}" />
          <div class="item-details">
            <h3>${item.productId.name}</h3>
            <p class="price">‚Çπ${item.productId.price}</p>
          </div>
          <div class="item-controls">
            <span class="quantity">Qty: ${item.quantity}</span>
            <button class="delete-btn">üóë</button>
          </div>
        `;

        // Delete button
        itemDiv.querySelector(".delete-btn").addEventListener("click", async () => {
          try {
            await fetch(`/api/cart/remove/${item.productId._id}`, { method: 'DELETE' });
            renderCart();
          } catch (error) {
            console.error('Error removing item from cart:', error);
          }
        });

        cartItemsDiv.appendChild(itemDiv);
      });

      totalSpan.textContent = `‚Çπ${cart.total}`;
    } catch (error) {
      console.error('Error fetching cart:', error);
      cartContainer.innerHTML = "<p>Error loading cart. Please try again later.</p>";
    }
  }

  payBtn.addEventListener("click", async () => {
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const house = document.getElementById("house").value.trim();
    const locality = document.getElementById("locality").value.trim();
    const city = document.getElementById("city").value.trim();
    const pincode = document.getElementById("pincode").value.trim();

    if(!name || !phone || !house || !locality || !city || !pincode){
      alert("‚ùå Please fill in all required address details before proceeding!");
      return;
    }

    const shippingAddress = `${name}, ${house}, ${locality}, ${city}, ${pincode}`;

    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ shippingAddress })
        });

        if (response.ok) {
            alert('Order placed successfully!');
            window.location.href = 'mainpage.html';
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to place order.');
        }
    } catch (error) {
        console.error('Error placing order:', error);
    }
  });

  renderCart();
});
</script>

</body>
</html>